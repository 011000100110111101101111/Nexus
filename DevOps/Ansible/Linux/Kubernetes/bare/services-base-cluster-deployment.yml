- hosts: masters
  become: yes # Run as root
  # TODO: Remove redundant commands
  vars:
    user: user
    metallbstart: "192.168.3.230"
    metallbend: "192.168.3.240"
  tasks:
    - name: Install Helm
      command: sudo snap install helm --classic
      become: yes
    - name: Prep Metallb
      shell: |
        kubectl get configmap kube-proxy -n kube-system -o yaml | sed -e "s/strictARP: false/strictARP: true/" | kubectl apply -f - -n kube-system
      become: yes
      become_user: "{{ user }}"
    - name: Install metallb
      shell: |
        MBLVER=$(curl -s https://api.github.com/repos/metallb/metallb/releases/latest|grep tag_name|cut -d '"' -f 4)
        kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/${MBLVER}/config/manifests/metallb-native.yaml
        sleep 10
      become: yes
      become_user: "{{ user }}"
    - name: Configure metallb IP address pool
      shell: |
        kubectl apply -f - <<EOF
        apiVersion: metallb.io/v1beta1
        kind: IPAddressPool
        metadata:
          name: first-pool
          namespace: metallb-system
        spec:
          addresses:
          - {{ metallbstart }}-{{ metallbend }}
        EOF
      become: yes
      become_user: "{{ user }}"
    - name: Configure metallb L2Advertisement
      shell: |
        kubectl apply -f - <<EOF
        apiVersion: metallb.io/v1beta1
        kind: L2Advertisement
        metadata:
          name: metallb-l2-advertisement
          namespace: metallb-system
        spec:
          ipAddressPools:
          - first-pool
        EOF
      become: yes
      become_user: "{{ user }}"
    - name: Rolling restart of metallb pods
      command: kubectl rollout restart deployment controller -n metallb-system
      become_user: "{{ user }}"
      become: yes
    - name: Create longhorn namespace
      kubernetes.core.k8s:
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: longhorn-system
        state: present
      become: yes
      become_user: "{{ user }}"
    - name: Add helm repo
      kubernetes.core.helm_repository:
        name: longhorn
        repo_url: https://charts.longhorn.io
      become: yes
      become_user: "{{ user }}"
    - name: Install Longhorn
      kubernetes.core.helm:
        name: longhorn
        chart_ref: longhorn/longhorn
        namespace: longhorn-system
      become: yes
      become_user: "{{ user }}"
    - name: Create NGINX namespace
      kubernetes.core.k8s:
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: ingress-nginx
        state: present
      become: yes
      become_user: "{{ user }}"
    - name: Install NGINX Ingress controller
      kubernetes.core.helm_repository:
        name: ingress-nginx
        repo_url: https://kubernetes.github.io/ingress-nginx
      become: yes
      become_user: "{{ user }}"
    - name: Install NGINX Ingress controller
      kubernetes.core.helm:
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        namespace: ingress-nginx
      become: yes
      become_user: "{{ user }}"
